<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>EcoTrack - Dashboard</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
        }

        .header {
            background: white;
            padding: 20px 30px;
            border-radius: 10px;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
            margin-bottom: 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        h1 {
            color: #667eea;
            font-size: 28px;
        }

        h2 {
            color: #374151;
            margin-bottom: 20px;
        }

        .user-info {
            display: flex;
            gap: 15px;
            align-items: center;
        }

        .btn {
            padding: 10px 20px;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-size: 14px;
            transition: all 0.3s;
        }

        .btn-primary {
            background: #667eea;
            color: white;
        }

        .btn-primary:hover {
            background: #5568d3;
        }

        .btn-danger {
            background: #ef4444;
            color: white;
        }

        .btn-danger:hover {
            background: #dc2626;
        }

        .card {
            background: white;
            padding: 25px;
            border-radius: 10px;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
            margin-bottom: 20px;
        }

        .auth-form {
            max-width: 400px;
            margin: 100px auto;
        }

        .form-group {
            margin-bottom: 15px;
        }

        label {
            display: block;
            margin-bottom: 5px;
            color: #374151;
            font-weight: 500;
        }

        input, select {
            width: 100%;
            padding: 10px;
            border: 1px solid #d1d5db;
            border-radius: 5px;
            font-size: 14px;
        }

        input:focus, select:focus {
            outline: none;
            border-color: #667eea;
        }

        .hidden {
            display: none;
        }

        .filters {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin-bottom: 20px;
        }

        table {
            width: 100%;
            border-collapse: collapse;
        }

        th, td {
            padding: 12px;
            text-align: left;
            border-bottom: 1px solid #e5e7eb;
        }

        th {
            background: #f9fafb;
            color: #374151;
            font-weight: 600;
        }

        tr:hover {
            background: #f9fafb;
        }

        .error {
            color: #ef4444;
            padding: 10px;
            background: #fee2e2;
            border-radius: 5px;
            margin-bottom: 15px;
        }

        .success {
            color: #10b981;
            padding: 10px;
            background: #d1fae5;
            border-radius: 5px;
            margin-bottom: 15px;
        }

        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin-bottom: 20px;
        }

        .stat-card {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 20px;
            border-radius: 10px;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
        }

        .stat-label {
            font-size: 14px;
            opacity: 0.9;
        }

        .stat-value {
            font-size: 32px;
            font-weight: bold;
            margin-top: 10px;
        }

        .tabs {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
        }

        .tab {
            padding: 10px 20px;
            border: none;
            background: white;
            border-radius: 5px;
            cursor: pointer;
            transition: all 0.3s;
        }

        .tab.active {
            background: #667eea;
            color: white;
        }

        .charts-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(400px, 1fr));
            gap: 20px;
            margin-top: 20px;
        }

        .chart-container {
            background: white;
            padding: 20px;
            border-radius: 10px;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
            height: 400px;
        }

        canvas {
            max-height: 100%;
        }
    </style>
</head>
<body>
    <!-- Auth Screen -->
    <div id="authScreen" class="card auth-form">
        <h1 style="text-align: center; margin-bottom: 20px;">EcoTrack</h1>
        <div id="errorMsg" class="error hidden"></div>
        
        <div class="tabs">
            <button class="tab active" onclick="showLoginForm()">Connexion</button>
            <button class="tab" onclick="showRegisterForm()">Inscription</button>
        </div>

        <!-- Login Form -->
        <form id="loginForm" onsubmit="login(event)">
            <div class="form-group">
                <label>Email</label>
                <input type="email" id="loginEmail" required>
            </div>
            <div class="form-group">
                <label>Mot de passe</label>
                <input type="password" id="loginPassword" required>
            </div>
            <button type="submit" class="btn btn-primary" style="width: 100%;">Se connecter</button>
        </form>

        <!-- Register Form -->
        <form id="registerForm" class="hidden" onsubmit="register(event)">
            <div class="form-group">
                <label>Email</label>
                <input type="email" id="registerEmail" required>
            </div>
            <div class="form-group">
                <label>Nom d'utilisateur</label>
                <input type="text" id="registerUsername" required>
            </div>
            <div class="form-group">
                <label>Mot de passe</label>
                <input type="password" id="registerPassword" required>
            </div>
            <button type="submit" class="btn btn-primary" style="width: 100%;">S'inscrire</button>
        </form>
    </div>

    <!-- Main App -->
    <div id="mainApp" class="container hidden">
        <div class="header">
            <h1>üåç EcoTrack Dashboard</h1>
            <div class="user-info">
                <span id="userEmail"></span>
                <button class="btn btn-danger" onclick="logout()">D√©connexion</button>
            </div>
        </div>

        <!-- Key Metrics -->
        <div class="card">
            <h2>üìä M√©triques Cl√©s</h2>
            <div class="stats-grid" id="keyMetrics"></div>
        </div>

        <!-- Charts -->
        <div class="card">
            <h2>üìà Visualisations</h2>
            <div class="charts-grid">
                <div class="chart-container">
                    <canvas id="airQualityChart"></canvas>
                </div>
                <div class="chart-container">
                    <canvas id="co2Chart"></canvas>
                </div>
                <div class="chart-container">
                    <canvas id="temperatureChart"></canvas>
                </div>
                <div class="chart-container">
                    <canvas id="comparisonChart"></canvas>
                </div>
            </div>
        </div>

        <!-- Indicators Table -->
        <div class="card">
            <h2>üìã D√©tail des Indicateurs</h2>
            
            <div class="filters">
                <div class="form-group">
                    <label>Type</label>
                    <select id="filterType" onchange="loadIndicators()">
                        <option value="">Tous</option>
                        <option value="air_quality">Qualit√© de l'air</option>
                        <option value="co2">√âmissions CO2</option>
                        <option value="temperature">Temp√©rature</option>
                        <option value="humidity">Humidit√©</option>
                    </select>
                </div>
                <div class="form-group">
                    <label>Ville</label>
                    <select id="filterZone" onchange="loadIndicators()">
                        <option value="">Toutes</option>
                    </select>
                </div>
            </div>

            <div id="successMsg" class="success hidden"></div>
            <div id="errorMsgMain" class="error hidden"></div>

            <div style="overflow-x: auto;">
                <table>
                    <thead>
                        <tr>
                            <th>ID</th>
                            <th>Source</th>
                            <th>Type</th>
                            <th>Valeur</th>
                            <th>Unit√©</th>
                            <th>Ville</th>
                            <th>Date</th>
                        </tr>
                    </thead>
                    <tbody id="indicatorsTable"></tbody>
                </table>
            </div>
        </div>

        <!-- Create Indicator Form (Admin only) -->
        <div id="adminSection" class="card hidden">
            <h2>‚ûï Cr√©er un indicateur (Admin)</h2>
            <form onsubmit="createIndicator(event)">
                <div style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 15px;">
                    <div class="form-group">
                        <label>Source</label>
                        <input type="text" id="newSource" required>
                    </div>
                    <div class="form-group">
                        <label>Type</label>
                        <select id="newType" required>
                            <option value="air_quality">Qualit√© de l'air</option>
                            <option value="co2">√âmissions CO2</option>
                            <option value="temperature">Temp√©rature</option>
                            <option value="humidity">Humidit√©</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label>Valeur</label>
                        <input type="number" step="0.01" id="newValue" required>
                    </div>
                    <div class="form-group">
                        <label>Unit√©</label>
                        <input type="text" id="newUnit" required>
                    </div>
                    <div class="form-group">
                        <label>Ville</label>
                        <select id="newZone" required></select>
                    </div>
                </div>
                <button type="submit" class="btn btn-primary">Cr√©er</button>
            </form>
        </div>
    </div>

    <script>
        const API_URL = 'http://127.0.0.1:8000';
        let token = localStorage.getItem('token');
        let userEmail = localStorage.getItem('userEmail');
        let userRole = localStorage.getItem('userRole');
        let charts = {};
        let zonesData = {}; // Variable globale pour stocker les zones

        // Initialize
        if (token) {
            showMainApp();
        }

        function showLoginForm() {
            document.getElementById('loginForm').classList.remove('hidden');
            document.getElementById('registerForm').classList.add('hidden');
            document.querySelectorAll('.tab')[0].classList.add('active');
            document.querySelectorAll('.tab')[1].classList.remove('active');
        }

        function showRegisterForm() {
            document.getElementById('loginForm').classList.add('hidden');
            document.getElementById('registerForm').classList.remove('hidden');
            document.querySelectorAll('.tab')[0].classList.remove('active');
            document.querySelectorAll('.tab')[1].classList.add('active');
        }

        async function login(e) {
            e.preventDefault();
            const email = document.getElementById('loginEmail').value;
            const password = document.getElementById('loginPassword').value;

            try {
                const formData = new URLSearchParams();
                formData.append('username', email);
                formData.append('password', password);

                const response = await fetch(`${API_URL}/auth/login`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/x-www-form-urlencoded',
                    },
                    body: formData
                });

                if (response.ok) {
                    const data = await response.json();
                    token = data.access_token;
                    localStorage.setItem('token', token);
                    localStorage.setItem('userEmail', email);
                    
                    const payload = JSON.parse(atob(token.split('.')[1]));
                    userRole = payload.role;
                    localStorage.setItem('userRole', userRole);
                    
                    showMainApp();
                } else {
                    showError('Email ou mot de passe incorrect');
                }
            } catch (error) {
                showError('Erreur de connexion');
            }
        }

        async function register(e) {
            e.preventDefault();
            const email = document.getElementById('registerEmail').value;
            const username = document.getElementById('registerUsername').value;
            const password = document.getElementById('registerPassword').value;

            try {
                const response = await fetch(`${API_URL}/auth/register`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({ email, username, password })
                });

                if (response.ok) {
                    showError('Inscription r√©ussie ! Vous pouvez vous connecter.', false);
                    showLoginForm();
                    document.getElementById('loginEmail').value = email;
                } else {
                    const data = await response.json();
                    showError(data.detail || 'Erreur lors de l\'inscription');
                }
            } catch (error) {
                showError('Erreur de connexion');
            }
        }

        function logout() {
            localStorage.clear();
            token = null;
            userEmail = null;
            userRole = null;
            document.getElementById('authScreen').classList.remove('hidden');
            document.getElementById('mainApp').classList.add('hidden');
        }

        async function showMainApp() {
            document.getElementById('authScreen').classList.add('hidden');
            document.getElementById('mainApp').classList.remove('hidden');
            document.getElementById('userEmail').textContent = localStorage.getItem('userEmail');
            
            if (userRole === 'admin') {
                document.getElementById('adminSection').classList.remove('hidden');
            }

            await loadZones();
            await loadIndicators();
            await loadKeyMetrics();
            await loadCharts();
        }

        async function loadZones() {
            try {
                const response = await fetch(`${API_URL}/zones/`);
                const zones = await response.json();
                
                // Stocker les zones dans un objet {id: nom}
                zones.forEach(zone => {
                    zonesData[zone.id] = zone.name;
                });
                
                const filterZone = document.getElementById('filterZone');
                const newZone = document.getElementById('newZone');
                
                zones.forEach(zone => {
                    filterZone.innerHTML += `<option value="${zone.id}">${zone.name}</option>`;
                    newZone.innerHTML += `<option value="${zone.id}">${zone.name}</option>`;
                });
            } catch (error) {
                console.error('Erreur chargement zones:', error);
            }
        }

        async function loadKeyMetrics() {
            try {
                const response = await fetch(`${API_URL}/indicators/?limit=1000`, {
                    headers: { 'Authorization': `Bearer ${token}` }
                });
                
                if (response.ok) {
                    const indicators = await response.json();
                    
                    // Calculer les m√©triques
                    const airQuality = indicators.filter(i => i.type === 'air_quality');
                    const co2 = indicators.filter(i => i.type === 'co2');
                    const temp = indicators.filter(i => i.type === 'temperature');
                    
                    const avgAir = airQuality.length > 0 
                        ? (airQuality.reduce((sum, i) => sum + i.value, 0) / airQuality.length).toFixed(1)
                        : 0;
                    const avgCo2 = co2.length > 0 
                        ? (co2.reduce((sum, i) => sum + i.value, 0) / co2.length).toFixed(0)
                        : 0;
                    const avgTemp = temp.length > 0 
                        ? (temp.reduce((sum, i) => sum + i.value, 0) / temp.length).toFixed(1)
                        : 0;
                    
                    const metricsHtml = `
                        <div class="stat-card">
                            <div class="stat-label">üå´Ô∏è Qualit√© de l'air moyenne</div>
                            <div class="stat-value">${avgAir} ¬µg/m¬≥</div>
                            <div class="stat-label">${airQuality.length} mesures</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-label">üè≠ √âmissions CO2 moyennes</div>
                            <div class="stat-value">${avgCo2} kg</div>
                            <div class="stat-label">${co2.length} mesures</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-label">üå°Ô∏è Temp√©rature moyenne</div>
                            <div class="stat-value">${avgTemp}¬∞C</div>
                            <div class="stat-label">${temp.length} mesures</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-label">üìä Total indicateurs</div>
                            <div class="stat-value">${indicators.length}</div>
                            <div class="stat-label">Toutes villes</div>
                        </div>
                    `;
                    
                    document.getElementById('keyMetrics').innerHTML = metricsHtml;
                }
            } catch (error) {
                console.error('Erreur m√©triques:', error);
            }
        }

        async function loadCharts() {
            try {
                const response = await fetch(`${API_URL}/indicators/?limit=1000`, {
                    headers: { 'Authorization': `Bearer ${token}` }
                });
                
                if (response.ok) {
                    const indicators = await response.json();
                    
                    // Chart 1: Air Quality over time
                    const airData = indicators
                        .filter(i => i.type === 'air_quality')
                        .sort((a, b) => new Date(a.timestamp) - new Date(b.timestamp))
                        .slice(0, 30);
                    
                    createLineChart('airQualityChart', 'Qualit√© de l\'air (30 derniers jours)', 
                        airData.map(i => new Date(i.timestamp).toLocaleDateString('fr-FR')),
                        airData.map(i => i.value),
                        'rgba(255, 99, 132, 0.5)'
                    );
                    
                    // Chart 2: CO2 emissions
                    const co2Data = indicators
                        .filter(i => i.type === 'co2')
                        .sort((a, b) => new Date(a.timestamp) - new Date(b.timestamp));
                    
                    createLineChart('co2Chart', '√âmissions CO2', 
                        co2Data.map(i => new Date(i.timestamp).toLocaleDateString('fr-FR')),
                        co2Data.map(i => i.value),
                        'rgba(75, 192, 192, 0.5)'
                    );
                    
                    // Chart 3: Temperature
                    const tempData = indicators
                        .filter(i => i.type === 'temperature')
                        .sort((a, b) => new Date(a.timestamp) - new Date(b.timestamp));
                    
                    createLineChart('temperatureChart', 'Temp√©rature', 
                        tempData.map(i => new Date(i.timestamp).toLocaleDateString('fr-FR')),
                        tempData.map(i => i.value),
                        'rgba(255, 206, 86, 0.5)'
                    );
                    
                    // Chart 4: Comparison by zone (avec noms de villes)
                    const zones = [...new Set(indicators.map(i => i.zone_id))];
                    const zoneAverages = zones.map(zoneId => {
                        const zoneData = indicators.filter(i => i.zone_id === zoneId && i.type === 'air_quality');
                        return zoneData.length > 0 
                            ? zoneData.reduce((sum, i) => sum + i.value, 0) / zoneData.length
                            : 0;
                    });
                    
                    createBarChart('comparisonChart', 'Qualit√© de l\'air par ville',
                        zones.map(z => zonesData[z] || `Zone ${z}`),
                        zoneAverages,
                        'rgba(153, 102, 255, 0.5)'
                    );
                }
            } catch (error) {
                console.error('Erreur charts:', error);
            }
        }

        function createLineChart(canvasId, label, labels, data, color) {
            const ctx = document.getElementById(canvasId);
            if (charts[canvasId]) {
                charts[canvasId].destroy();
            }
            charts[canvasId] = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: labels,
                    datasets: [{
                        label: label,
                        data: data,
                        borderColor: color.replace('0.5', '1'),
                        backgroundColor: color,
                        tension: 0.3
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: { display: true }
                    }
                }
            });
        }

        function createBarChart(canvasId, label, labels, data, color) {
            const ctx = document.getElementById(canvasId);
            if (charts[canvasId]) {
                charts[canvasId].destroy();
            }
            charts[canvasId] = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: labels,
                    datasets: [{
                        label: label,
                        data: data,
                        backgroundColor: color,
                        borderColor: color.replace('0.5', '1'),
                        borderWidth: 1
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: { display: false }
                    }
                }
            });
        }

        async function loadIndicators() {
            const type = document.getElementById('filterType').value;
            const zoneId = document.getElementById('filterZone').value;
            
            let url = `${API_URL}/indicators/?limit=50`;
            if (type) url += `&type=${type}`;
            if (zoneId) url += `&zone_id=${zoneId}`;

            try {
                const response = await fetch(url, {
                    headers: { 'Authorization': `Bearer ${token}` }
                });

                if (response.ok) {
                    const indicators = await response.json();
                    displayIndicators(indicators);
                }
            } catch (error) {
                showErrorMain('Erreur de chargement des indicateurs');
            }
        }

        function displayIndicators(indicators) {
            const tbody = document.getElementById('indicatorsTable');
            tbody.innerHTML = '';

            indicators.forEach(ind => {
                const date = new Date(ind.timestamp).toLocaleDateString('fr-FR');
                const zoneName = zonesData[ind.zone_id] || `Zone ${ind.zone_id}`;
                tbody.innerHTML += `
                    <tr>
                        <td>${ind.id}</td>
                        <td>${ind.source}</td>
                        <td>${ind.type}</td>
                        <td>${ind.value}</td>
                        <td>${ind.unit}</td>
                        <td>${zoneName}</td>
                        <td>${date}</td>
                    </tr>
                `;
            });
        }

        async function createIndicator(e) {
            e.preventDefault();
            
            const data = {
                source: document.getElementById('newSource').value,
                type: document.getElementById('newType').value,
                value: parseFloat(document.getElementById('newValue').value),
                unit: document.getElementById('newUnit').value,
                zone_id: parseInt(document.getElementById('newZone').value)
            };

            try {
                const response = await fetch(`${API_URL}/indicators/`, {
                    method: 'POST',
                    headers: {
                        'Authorization': `Bearer ${token}`,
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(data)
                });

                if (response.ok) {
                    showSuccess('Indicateur cr√©√© avec succ√®s !');
                    e.target.reset();
                    await loadIndicators();
                    await loadKeyMetrics();
                    await loadCharts();
                } else {
                    showErrorMain('Erreur lors de la cr√©ation');
                }
            } catch (error) {
                showErrorMain('Erreur de connexion');
            }
        }

        function showError(msg, isError = true) {
            const errorDiv = document.getElementById('errorMsg');
            errorDiv.textContent = msg;
            errorDiv.classList.remove('hidden');
            if (!isError) {
                errorDiv.classList.remove('error');
                errorDiv.classList.add('success');
            }
            setTimeout(() => errorDiv.classList.add('hidden'), 3000);
        }

        function showErrorMain(msg) {
            const errorDiv = document.getElementById('errorMsgMain');
            errorDiv.textContent = msg;
            errorDiv.classList.remove('hidden');
            setTimeout(() => errorDiv.classList.add('hidden'), 3000);
        }

        function showSuccess(msg) {
            const successDiv = document.getElementById('successMsg');
            successDiv.textContent = msg;
            successDiv.classList.remove('hidden');
            setTimeout(() => successDiv.classList.add('hidden'), 3000);
        }
    </script>
</body>
</html>